{% extends 'forum/forum_base.html' %}
{% block head %}
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.tiny.cloud/1/1aub2fra26v0pjhe6ra0de6egt98fnmfiby43teo6qikfwoe/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <link rel="stylesheet" href="{% static 'forum/post_detail.css' %}">
{% endblock head %}
{% block title %}
{% endblock title %}
{% block content %}
    {% load humanizing_date %}
    <section class="thread_section">
    <div class="thread_author_post_headline">
          <div class="breadcrumbs_topic">
                <a href="{% url 'forum:forum_main' %}">Форум</a><p> > {{ topic.title }}</p>
            </div>
        <p class="post_headline">{{ post.name }}</p>
        <div class="post_author_line_num">
            <div class="post_author_date">
                <div class="post_author_avatar_nickname"><img class="post_author_avatar" src="{{ post.author.avatar.url }}"><p class="post_author_nickname">{{ post.author }}</p></div>
                <div class="post_author_humanized_date">{% humanizing request post.date %}</div>
            </div>
            <div class="post_stats">
                <div style="display: flex;"><i></i>{{ post.views }}</div>
                <div style="display: flex"><i class="comment"></i>{{ post.count_comments }}</div>
            </div>
        </div>
    </div>
    <div class="comment_post">
        <div class="comment_post_author">
            <p>{{ post.author }}</p>
            {% if post.author.is_admin %}
            <a class="comment_author_admin">Администратор</a>
            {% elif post.author.is_banned %}
            <a class="comment_author_banned">Забанен</a>
            {% else %}
            <a class="comment_author_usual">Пользователь</a>
            {% endif %}
        <img class="comment_post_avatar" src="{{ post.author.avatar.url }}">
        <p>Дата регистрации: 2022:12:12</p>
        <p>Сообщения: 24325</p>
        </div>
        <div class="comment_post_content">
            <p>{% humanizing request post.date %}</p>
            <div>{{ post.content|safe }}</div>
            <div class="comment_post_row"></div>
        </div>
    </div>
    {% for comment in post.get_comments %}
        <div class="comment_post">
        <div class="comment_post_author">
            <p>{{ comment.author }}</p>
            {% if comment.author.is_admin %}
            <a class="comment_author_admin">Администратор</a>
            {% elif comment.author.is_banned %}
            <a class="comment_author_banned">Забанен</a>
            {% else %}
            <a class="comment_author_usual">Пользователь</a>
            {% endif %}
        <img class="comment_post_avatar" src="{{ comment.author.avatar.url }}">
        <p>Дата регистрации: 2022:12:12</p>
        <p>Сообщения: 24325</p>
        </div>
        <div class="comment_post_content">
            <p>{% humanizing request post.date %}</p>
            <div>{{ comment.content|safe }}</div>
            <div class="comment_post_row">
                <div class="like_dislike_wrapper">
                    <div id="like" data-comment="{{ comment.pk }}"><i class="like_btn"></i><p id="liked">{{ comment.count_likes }}</p></div>
                    <div id="dislike" data-comment="{{ comment.pk }}"><i class="dislike_btn"></i><p id="disliked">{{ comment.count_dislikes }}</p></div>
                    {% csrf_token %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    </section>
    <script>
$( document ).ready(function() {
    $('#editorOne').html('{{post.content}}');
    $('#like').click(function (){

        $.ajax({
            type: 'POST',
            url: "{% url 'forum:like' post.pk %}",
            data:{
                csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val(),
                comment_pk: $(this).attr('data-comment'),

            },
            success: function (response){
                if (response.liked === true){
                    if (response.default === 'already'){

                    }
                    else{
                    $('#liked').text(parseInt($('#liked').text())+1)
                    if (response.default === 'from dislike'){
                        $('#disliked').text(parseInt($('#disliked').text())-1)
                    }
                }
                }
            }
        })
    })
    $('#dislike').click(function (){
        $.ajax({
            type: 'POST',
            url: "{% url 'forum:dislike' post.pk %}",
            data:{
                csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val(),
                comment_pk: $(this).attr('data-comment')
            },
            success: function (response){
                    if (response.disliked === true){
                        if (response.default === 'already'){

                        }
                        else {
                            $('#disliked').text(parseInt($('#disliked').text()) + 1)
                            if (response.default === 'from like') {
                                $('#liked').text(parseInt($('#liked').text()) - 1)
                            }
                        }
                }
            }
        })
    })

});




    </script>
{% endblock content %}